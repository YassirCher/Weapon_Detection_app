{% extends 'base.html' %}
{% load static %}

{% block title %}Détection d'Image | Sécurité Urbaine{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Animation d'entrée pour la carte */
    .upload-card {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Style du conteneur d'upload */
    .upload-area {
        position: relative;
        transition: all 0.3s ease-in-out;
        border: 2px dashed #d1d5db;
        border-radius: 0.75rem;
        background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
        min-height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .upload-area:hover {
        border-color: #2563eb;
        background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.1);
        transform: translateY(-2px);
    }
    .upload-area.dragover {
        border-color: #2563eb;
        background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1), 0 10px 25px rgba(37, 99, 235, 0.2);
        transform: scale(1.02);
    }
    .upload-area img {
        max-width: 100%;
        max-height: 220px;
        border-radius: 0.5rem;
        object-fit: contain;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    /* Masquer l'icône de fond quand il y a du contenu */
    .upload-area.has-content {
        background: #ffffff;
        border-style: solid;
    }
    /* Style du texte dans la prévisualisation */
    #preview {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    /* Style des inputs */
    .form-input {
        transition: all 0.3s ease-in-out;
        border-width: 0 0 2px 0;
        border-color: #d1d5db;
        background: transparent;
        padding: 0.5rem 0;
    }
    .form-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 2px 0 0 #0d6efd;
        outline: none;
    }
    /* Ligne animée au survol du bouton */
    .btn-hover {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease-in-out;
    }
    .btn-hover::after {
        content: '';
        position: absolute;
        width: 0;
        height: 3px;
        bottom: 0;
        left: 0;
        background: linear-gradient(90deg, #0d6efd, #4dabf7);
        transition: width 0.3s ease-in-out;
    }
    .btn-hover:hover::after {
        width: 100%;
    }
    .btn-hover:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    /* Spinner */
    .spinner {
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        width: 1.25rem;
        height: 1.25rem;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 font-inter px-4 sm:px-6 lg:px-8 mt-0 pt-0">
    <div class="max-w-2xl mx-auto mt-10">
        <div class="upload-card bg-white shadow-lg shadow-gray-200 rounded-xl overflow-hidden">
            <!-- En-tête de la carte -->
            <div class="bg-[#0d6efd] text-white px-6 py-5">
                <h5 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-camera mr-2"></i> Détection d'Image ou Vidéo
                </h5>
            </div>
            <!-- Corps de la carte -->
            <div class="p-6">
                <!-- Mode Simulation -->
                {% if app_settings.active_detection_model == 'simulation' %}
                    <div class="bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm mb-4 flex items-center justify-between">
                        <span class="flex items-center"><i class="fas fa-info-circle mr-2"></i> <strong>Mode Simulation :</strong> Les détections sont simulées et ne représentent pas des analyses réelles.</span>
                    </div>
                {% endif %}

                <!-- Messages Django -->
                {% if messages %}
                    <div class="mb-4">
                        {% for message in messages %}
                            <div class="bg-{% if message.tags == 'error' %}red-50{% elif message.tags == 'success' %}green-50{% else %}{{ message.tags }}-50{% endif %} text-{% if message.tags == 'error' %}red-700{% elif message.tags == 'success' %}green-700{% else %}{{ message.tags }}-700{% endif %} p-3 rounded-lg text-sm flex items-center justify-between">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <form method="post" action="{% url 'detection:upload' %}" enctype="multipart/form-data" id="upload-form" class="space-y-6">
                    {% csrf_token %}

                    <!-- Zone d'upload de l'image ou vidéo -->
                    <div>
                        <label for="{{ form.image.id_for_label }}" 
                               class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-file-video mr-1"></i> {{ form.image.label }}
                        </label>
                        <div class="upload-area relative" id="upload-area">
                            <input type="file" name="image" id="{{ form.image.id_for_label }}" 
                                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                                   accept="image/jpeg,image/png,image/webp,image/jfif,video/mp4,video/avi,video/quicktime">
                            <div id="preview" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                {% if uploaded_image %}
                                    <img src="{{ uploaded_image.url }}" alt="Fichier uploadé" class="rounded-lg">
                                {% else %}
                                    <button type="button" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200 hover:shadow-lg transform hover:-translate-y-0.5 mb-3 pointer-events-auto" onclick="document.getElementById('{{ form.image.id_for_label }}').click()">
                                        <i class="fas fa-folder-open mr-2"></i>
                                        Choose File
                                    </button>
                                    <span class="text-gray-500 text-center text-sm">or drag and drop your file here</span>
                                    <span class="text-gray-400 text-xs mt-2">Supported: JPG, PNG, WEBP, MP4, AVI, MOV</span>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Div pour les erreurs de validation du fichier -->
                        <div id="file-error" class="text-red-600 text-sm mt-1 hidden"></div>
                        <div class="text-sm text-gray-500 mt-1">{{ form.image.help_text }}</div>
                        {% if form.image.errors %}
                            <div class="text-red-600 text-sm mt-1">
                                {% for error in form.image.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Localisation -->
                    <div>
                        <label for="{{ form.location.id_for_label }}" 
                               class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-1"></i> {{ form.location.label }}
                        </label>
                        <input type="text" name="location" id="{{ form.location.id_for_label }}" 
                               value="{{ form.location.value|default:'' }}" maxlength="200"
                               class="form-input block w-full text-gray-900 placeholder-gray-400">
                        <div class="text-sm text-gray-500 mt-1">{{ form.location.help_text }}</div>
                        {% if form.location.errors %}
                            <div class="text-red-600 text-sm mt-1">
                                {% for error in form.location.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Intervalle d'analyse vidéo -->
                    <div id="video-settings" style="display: none;">
                        <label for="{{ form.video_frame_interval.id_for_label }}" 
                               class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-film mr-1"></i> {{ form.video_frame_interval.label }}
                        </label>
                        <input type="number" name="video_frame_interval" id="{{ form.video_frame_interval.id_for_label }}" 
                               value="30" min="1" max="300"
                               class="form-input block w-full text-gray-900 placeholder-gray-400">
                        <div class="text-sm text-gray-500 mt-1">{{ form.video_frame_interval.help_text }}</div>
                        {% if form.video_frame_interval.errors %}
                            <div class="text-red-600 text-sm mt-1">
                                {% for error in form.video_frame_interval.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Bouton de soumission -->
                    <div>
                        <button type="submit" 
                                class="btn-hover w-full bg-[#0d6efd] text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-all duration-300 flex items-center justify-center text-base font-semibold shadow-md hover:shadow-lg" 
                                id="detection-btn">
                            <i class="fas fa-search mr-2"></i> Lancer la Détection
                        </button>
                    </div>
                </form>
            </div>
            <!-- Pied de page -->
            <div class="bg-gray-100 text-gray-600 text-sm px-6 py-4 flex items-center justify-between">
                <span class="flex items-center"><i class="fas fa-info-circle mr-1"></i> L'image téléchargée sera analysée pour détecter des objets potentiellement dangereux.</span>
                {% if app_settings.active_detection_model == 'simulation' %}
                    <span class="inline-block px-2 py-1 rounded-full bg-yellow-500 text-gray-900 text-xs font-medium">Simulation</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('{{ form.image.id_for_label }}');
    const uploadArea = document.getElementById('upload-area');
    const preview = document.getElementById('preview');
    const uploadForm = document.getElementById('upload-form');
    const detectionButton = document.getElementById('detection-btn');
    const fileError = document.getElementById('file-error');

    // Gestion du drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
        console.log('Drag over detected');
    });
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
        console.log('Drag leave detected');
    });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
            console.log('Dropped file:', file.name, 'Type:', file.type);
            handleFile(file);
            fileInput.files = e.dataTransfer.files; // Mettre à jour fileInput avec les fichiers dropés
        }
    });

    // Prévisualisation et gestion du fichier
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        console.log('Selected file:', file ? file.name : 'No file', 'Type:', file ? file.type : 'None');
        if (file) handleFile(file);
    });

    function handleFile(file) {
        // Valid extensions and MIME types for images and videos
        const validImageExtensions = ['jpg', 'jpeg', 'png', 'webp', 'jfif'];
        const validVideoExtensions = ['mp4', 'avi', 'mov'];
        const validImageMimeTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jfif'];
        const validVideoMimeTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo'];
        
        // Extract extension
        const fileExtension = file.name.toLowerCase().split('.').pop();
        console.log('File extension:', fileExtension, 'MIME type:', file.type);

        // Clear previous error
        fileError.classList.add('hidden');
        fileError.textContent = '';

        const isImage = validImageExtensions.includes(fileExtension) || validImageMimeTypes.includes(file.type);
        const isVideo = validVideoExtensions.includes(fileExtension) || validVideoMimeTypes.includes(file.type);

        // Validate extension and MIME type
        if (!isImage && !isVideo) {
            console.log('Invalid file: Extension or MIME type not allowed');
            fileError.textContent = 'Le fichier doit être une image (JPG, PNG) ou une vidéo (MP4, AVI, MOV).';
            fileError.classList.remove('hidden');
            fileInput.value = ''; // Clear the input
            uploadArea.classList.remove('has-content'); // Réafficher l'icône de fond
            preview.innerHTML = `
                <button type="button" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200 hover:shadow-lg transform hover:-translate-y-0.5 mb-3 pointer-events-auto" onclick="document.getElementById('{{ form.image.id_for_label }}').click()">
                    <i class="fas fa-folder-open mr-2"></i>
                    Choose File
                </button>
                <span class="text-gray-500 text-center text-sm">or drag and drop your file here</span>
                <span class="text-gray-400 text-xs mt-2">Supported: JPG, PNG, WEBP, MP4, AVI, MOV</span>
            `;
            document.getElementById('video-settings').style.display = 'none';
            return;
        }

        console.log('Valid file detected, proceeding to preview');
        
        // Show video settings if it's a video
        if (isVideo) {
            document.getElementById('video-settings').style.display = 'block';
            uploadArea.classList.add('has-content'); // Masquer l'icône de fond
            preview.innerHTML = `<div class="text-center"><i class="fas fa-video text-6xl text-blue-500 mb-2"></i><p class="text-gray-600 mt-2">${file.name}</p><p class="text-sm text-gray-500">Vidéo prête pour analyse</p></div>`;
        } else {
            document.getElementById('video-settings').style.display = 'none';
            uploadArea.classList.add('has-content'); // Masquer l'icône de fond
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `<img src="${e.target.result}" alt="Prévisualisation" class="rounded-lg">`;
            };
            reader.readAsDataURL(file);
        }
    }

    // Validation et chargement
    uploadForm.addEventListener('submit', (e) => {
        console.log('Form submit triggered. Files length:', fileInput.files.length);
        // Clear previous error
        fileError.classList.add('hidden');
        fileError.textContent = '';

        if (!fileInput.files.length) {
            e.preventDefault();
            fileError.textContent = 'Veuillez sélectionner une image (JPG, JPEG, PNG, WEBP, JFIF).';
            fileError.classList.remove('hidden');
            console.log('No file selected, submission prevented');
            return;
        }

        detectionButton.disabled = true;
        detectionButton.innerHTML = `<span class="spinner mr-2"></span> Analyse en cours...`;
        console.log('Form submission proceeding');
    });
});
</script>
{% endblock %}