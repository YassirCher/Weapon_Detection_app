{% extends 'base.html' %}
{% load static %}

{% block title %}Nouvelle Détection | Sécurité Urbaine{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
    <div class="w-full max-w-2xl bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-blue-600 text-white rounded-t-xl px-6 py-4 text-xl font-semibold flex items-center">
            <i class="fas fa-photo-video mr-3"></i> Nouvelle Détection (Images/Vidéos)
        </div>

        <div class="p-6">
            {% if app_settings.active_detection_model == 'simulation' %}
            <div class="bg-yellow-100 text-yellow-800 border border-yellow-300 px-4 py-3 rounded-lg mb-4 flex items-center" role="alert">
                <i class="fas fa-info-circle mr-3"></i>
                <div>
                    <strong class="font-semibold">Mode Simulation :</strong> Les détections sont simulées et ne représentent pas des analyses réelles.
                </div>
            </div>
            {% endif %}

            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                <div class="px-4 py-3 rounded-lg mb-2 flex items-center
                    {% if message.tags == 'error' %}bg-red-100 text-red-800 border border-red-300
                    {% elif message.tags == 'success' %}bg-green-100 text-green-800 border border-green-300
                    {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-300
                    {% else %}bg-gray-100 text-gray-800 border border-gray-300{% endif %}" role="alert">
                    <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} mr-3"></i>
                    <div>{{ message }}</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <form method="post" action="{% url 'detection:upload_multi' %}" enctype="multipart/form-data" id="upload-form">
                {% csrf_token %}

                <div class="mb-5">
                    <label for="{{ form.files.id_for_label }}" class="block text-gray-700 text-sm font-semibold mb-2">
                        {{ form.files.label }}
                    </label>
                    <input type="file" name="files"
                           class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                           id="{{ form.files.id_for_label }}" accept="image/jpeg,image/png,video/mp4,video/avi,video/quicktime,application/zip" multiple>
                    <p class="mt-2 text-sm text-gray-500">Sélectionnez plusieurs images (JPG, PNG), vidéos (MP4, AVI, MOV) ou un seul fichier ZIP. Max : Images 10 Mo, Vidéos 500 Mo, ZIP 100 Mo.</p>
                    {% if form.files.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {% for error in form.files.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div id="file-preview-area" class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden">
                        <div id="image-thumbnails" class="flex flex-wrap gap-3 items-center"></div>
                        <div id="zip-preview" class="hidden flex items-center text-blue-700 font-medium">
                            <i class="fas fa-file-archive text-2xl mr-2"></i>
                            <span id="zip-filename"></span>
                        </div>
                    </div>
                </div>

                <div class="mb-5">
                    <label for="{{ form.report_name.id_for_label }}" class="block text-gray-700 text-sm font-semibold mb-2">
                        {{ form.report_name.label }}
                    </label>
                    <input type="text" name="report_name"
                           class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                           id="{{ form.report_name.id_for_label }}" value="{{ form.report_name.value|default:'' }}" maxlength="100"
                           placeholder="Ex: Rapport du 15 mai 2025 - Incident Rue Principale Meknès">
                    <p class="mt-2 text-sm text-gray-500">Optionnel. Si non spécifié, un nom basé sur la date sera utilisé.</p>
                    {% if form.report_name.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {% for error in form.report_name.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="mb-6">
                    <label for="{{ form.location.id_for_label }}" class="block text-gray-700 text-sm font-semibold mb-2">
                        {{ form.location.label }}
                    </label>
                    <textarea name="location"
                              class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                              id="{{ form.location.id_for_label }}" rows="3"
                              placeholder="Ex: 123 Rue Abc, Centre-ville , Meknès">{{ form.location.value|default:'' }}</textarea>
                    <p class="mt-2 text-sm text-gray-500">Optionnel. Indiquez le lieu de la détection. Si vide, votre localisation de profil sera utilisée.</p>
                    {% if form.location.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {% for error in form.location.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="mb-6" id="video-settings" style="display: none;">
                    <label for="{{ form.video_frame_interval.id_for_label }}" class="block text-gray-700 text-sm font-semibold mb-2">
                        <i class="fas fa-film mr-1"></i> {{ form.video_frame_interval.label }}
                    </label>
                    <input type="number" name="video_frame_interval"
                           class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out"
                           id="{{ form.video_frame_interval.id_for_label }}" value="30" min="1" max="300">
                    <p class="mt-2 text-sm text-gray-500">{{ form.video_frame_interval.help_text }}</p>
                    {% if form.video_frame_interval.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {% for error in form.video_frame_interval.errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="flex justify-end">
                    <button type="submit"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md text-lg font-semibold shadow-md transition duration-200 ease-in-out flex items-center justify-center"
                            id="detection-btn">
                        <i class="fas fa-search mr-2"></i> Lancer la Détection
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-gray-50 px-6 py-4 text-gray-500 text-sm italic border-t border-gray-200 rounded-b-xl">
            <i class="fas fa-info-circle mr-1"></i>
            Les fichiers téléchargés sont analysés pour détecter des objets potentiellement dangereux.
            {% if app_settings.active_detection_model == 'simulation' %}
            <span class="ml-2 bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full text-xs font-medium">Simulation</span>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('{{ form.files.id_for_label }}');
        const filePreviewArea = document.getElementById('file-preview-area');
        const imageThumbnails = document.getElementById('image-thumbnails');
        const zipPreview = document.getElementById('zip-preview');
        const zipFilename = document.getElementById('zip-filename');
        const submitButton = document.getElementById('detection-btn');

        fileInput.addEventListener('change', function() {
            updateFilePreview(this.files);
        });

        function updateFilePreview(files) {
            imageThumbnails.innerHTML = '';
            zipPreview.classList.add('hidden');
            filePreviewArea.classList.add('hidden');
            
            // Check if any video files are present
            const hasVideo = Array.from(files).some(file => {
                const ext = file.name.toLowerCase().split('.').pop();
                return ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv'].includes(ext) || file.type.startsWith('video/');
            });
            
            // Show/hide video settings
            const videoSettings = document.getElementById('video-settings');
            if (hasVideo) {
                videoSettings.style.display = 'block';
            } else {
                videoSettings.style.display = 'none';
            }

            if (files.length === 0) {
                return;
            }

            const isZipFile = files.length === 1 && files[0].name.toLowerCase().endsWith('.zip');

            if (isZipFile) {
                zipFilename.textContent = files[0].name;
                zipPreview.classList.remove('hidden');
                filePreviewArea.classList.remove('hidden');
            } else {
                const mediaFiles = Array.from(files);
                const maxThumbnails = 5;

                mediaFiles.slice(0, maxThumbnails).forEach(file => {
                    const isVideo = file.type.startsWith('video/') || ['mp4', 'avi', 'mov'].includes(file.name.toLowerCase().split('.').pop());
                    
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'relative w-20 h-20 rounded-lg overflow-hidden border border-gray-300 shadow-sm';
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'w-full h-full object-cover';
                            img.alt = file.name;
                            imgContainer.appendChild(img);
                            imageThumbnails.appendChild(imgContainer);
                        };
                        reader.readAsDataURL(file);
                    } else if (isVideo) {
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'relative w-20 h-20 rounded-lg overflow-hidden border border-blue-300 bg-blue-50 shadow-sm flex items-center justify-center';
                        videoContainer.innerHTML = '<i class="fas fa-video text-blue-500 text-2xl"></i>';
                        imageThumbnails.appendChild(videoContainer);
                    }
                });

                if (mediaFiles.length > maxThumbnails) {
                    const moreBadge = document.createElement('div');
                    moreBadge.className = 'flex items-center justify-center w-20 h-20 rounded-lg bg-gray-200 text-gray-600 font-semibold text-sm border border-gray-300 shadow-sm';
                    moreBadge.textContent = `+${mediaFiles.length - maxThumbnails}`;
                    imageThumbnails.appendChild(moreBadge);
                }

                if (mediaFiles.length > 0) {
                    filePreviewArea.classList.remove('hidden');
                }
            }
        }

        document.getElementById('upload-form').addEventListener('submit', function(event) {
            const files = Array.from(fileInput.files);

            if (!files.length) {
                event.preventDefault();
                alert('Veuillez sélectionner au moins une image (JPG, PNG) ou un fichier ZIP.');
                return;
            }

            const validExtensions = ['.jpg', '.jpeg', '.png', '.zip'];
            const hasZip = files.some(f => f.name.toLowerCase().endsWith('.zip'));
            const hasImages = files.some(f => f.name.toLowerCase().endsWith('.jpg') || f.name.toLowerCase().endsWith('.jpeg') || f.name.toLowerCase().endsWith('.png'));

            // Check for invalid file types
            if (!files.every(f => validExtensions.some(ext => f.name.toLowerCase().endsWith(ext)))) {
                event.preventDefault();
                alert('Tous les fichiers doivent être des images (JPG, PNG) ou un fichier ZIP.');
                return;
            }

            // Check for mixed types (images and ZIP)
            if (hasZip && hasImages) {
                event.preventDefault();
                alert('Vous ne pouvez pas uploader des images et un fichier ZIP simultanément.');
                return;
            }

            // Check for more than one ZIP file
            if (hasZip && files.length > 1) {
                event.preventDefault();
                alert('Vous ne pouvez uploader qu\'un seul fichier ZIP.');
                return;
            }

            // Client-side ZIP size check (optional, but good UX)
            if (hasZip && files[0].size > 100 * 1024 * 1024) { // 100 MB
                event.preventDefault();
                alert('Le fichier ZIP dépasse la taille maximale autorisée de 100 Mo.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Analyse en cours...';
            submitButton.classList.add('opacity-75', 'cursor-not-allowed');
        });
    });
</script>
{% endblock %}